<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>POSB PayLah SG60 Merchants Map</title>
  <!--
    This page visualises the hawker centres, coffeeshops and industrial canteens
    participating in the POSB PayLah SG60 promotion.  The data is loaded
    dynamically from the accompanying sg60_merchants.json file and geocoded
    on‑the‑fly using OpenStreetMap’s Nominatim service.  A Leaflet map is
    employed to display markers for each venue, clustered to remain
    performant even with hundreds of points.  Each marker’s popup lists
    every stall at that venue with its unit number when available.
  -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        integrity="sha256-VHwjz6zQ8dS+GY+x5j9N8QNttUTJcHh0nUFLwJefkKE="
        crossorigin=""/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
    }
    h1 {
      margin: 0;
      padding: 1rem;
      background: #f0f0f0;
      font-size: 1.5rem;
      text-align: center;
    }
    #map {
      height: calc(100vh - 3rem);
      width: 100%;
    }
    /* limit the popup height so long stall lists don’t overflow the screen */
    .popup-stalls {
      max-height: 200px;
      overflow-y: auto;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    td {
      padding: 2px 4px;
      vertical-align: top;
    }
    td:nth-child(2) {
      text-align: right;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <h1>POSB PayLah SG60 Merchants Map</h1>
  <div id="map"></div>

  <!-- Leaflet JS and marker cluster plugin -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
          integrity="sha256-oXzT8NpI603J8CtmNXuqFX9z9buC54pVy1QtL5o1wWc="
          crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <script>
    // Geocode an address using the public Nominatim API.  The query string
    // includes “Singapore” to improve accuracy and limit results.  If no
    // result is found this function resolves with null.
    async function geocode(address) {
      const url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(address + ', Singapore');
      try {
        const response = await fetch(url);
        if (!response.ok) {
          return null;
        }
        const data = await response.json();
        if (data.length > 0) {
          return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
        }
      } catch (e) {
        console.error('Geocoding error for', address, e);
      }
      return null;
    }

    // Load the venue data from the JSON file packaged with this site.
    async function loadData() {
      const response = await fetch('sg60_merchants.json');
      if (!response.ok) {
        throw new Error('Failed to load merchant data');
      }
      return response.json();
    }

    async function init() {
      // Initialise the map centred roughly on Singapore.
      const map = L.map('map').setView([1.3521, 103.8198], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // Create a marker cluster group to handle large numbers of markers.
      const markers = L.markerClusterGroup();

      const venues = await loadData();

      // Sequentially geocode each venue and add its marker.  Geocoding is
      // intentionally performed one after another to mitigate the risk of
      // overwhelming the free Nominatim API.  For large data sets this will
      // result in a noticeable loading delay; however it’s a responsible
      // trade‑off for reliability.

      // Track how many markers have been placed at the same rounded
      // coordinates.  Nominatim sometimes returns identical lat/lon for
      // different venues; if we plot markers with the exact same values
      // they will overlap and be impossible to click individually.  To
      // mitigate this, we slightly offset each subsequent marker at the
      // same location.  We use the lat/lon rounded to 5 decimal places
      // (~1 metre precision) as the key.  When a duplicate is detected,
      // markers are placed in a radial pattern around the original
      // coordinate.
      const coordCounts = {};
      for (const venue of venues) {
        const coords = await geocode(venue.address);
        if (!coords) continue;

        // Determine how many markers already exist at this location
        const key = coords.lat.toFixed(5) + ',' + coords.lon.toFixed(5);
        if (!coordCounts[key]) {
          coordCounts[key] = 0;
        }
        const duplicateIndex = coordCounts[key]++;

        // Offset subsequent markers in a circular pattern.  The offset
        // distance is small (approx. 15 metres) so that markers remain
        // close to their true location but are distinguishable.  Angles
        // step through 45° increments to distribute points evenly.
        const offsetDistance = 0.00015;
        const angleRad = (duplicateIndex * 45) * Math.PI / 180;
        const latOffset = offsetDistance * Math.cos(angleRad);
        const lonOffset = offsetDistance * Math.sin(angleRad);
        const adjLat = coords.lat + latOffset;
        const adjLon = coords.lon + lonOffset;

        // Build a popup listing the venue and stalls.  HTML is escaped for
        // stall names to avoid issues with special characters.
        let popupHtml = `<strong>${venue.name}</strong><br>${venue.address}<br><em>${venue.category}</em><br>`;
        popupHtml += '<div class="popup-stalls"><table>';
        for (const stall of venue.stalls) {
          const safeName = stall.name.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          const unit = stall.unit ? stall.unit : '';
          popupHtml += `<tr><td>${safeName}</td><td>${unit}</td></tr>`;
        }
        popupHtml += '</table></div>';
        const marker = L.marker([adjLat, adjLon]);
        marker.bindPopup(popupHtml);
        markers.addLayer(marker);
      }
      map.addLayer(markers);
    }

    // Kick off the initialisation once the page has loaded.
    init().catch(err => console.error(err));
  </script>
</body>
</html>